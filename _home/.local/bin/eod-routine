#!/bin/bash

if [[ $EOD_ROUTINE_INHIBIT != 1 ]]; then
	export EOD_ROUTINE_INHIBIT=1
	exec systemd-inhibit --who="eod-routine" --why="backing up data" "$0" "$@"
fi

suki="suki"
helikon="zuu.re"
shaggydog="shaggydog"
lavendel="lavendel"
subvolumes=("/home" "/etc" "/var" "/usr/local")
hostname="$(hostname)"	

if [[ "$(hostname)" == "suyin-arch" ]]; then
	helikon="helikon.local"
	subvolumes=("/home/daan" "/etc" "/var" "/usr/local")
fi

echo >&2 "Saving package list"
pacman -Qe >"$HOME/Documents/Vault/$(hostname)_packages.txt"

echo >&2 "Making filesystem snapshot"
for subvol in "${subvolumes[@]}"; do
	saveto="/.snapshots/$(date '+%Y%m%d')$(echo "$subvol" | sed 's/\//\-/g')"
	if [ -e "$saveto" ]; then
		echo "$saveto already exists, skipping snapshot"
	else
		sudo btrfs subvolume snapshot "$subvol" "$saveto"
	fi
done
echo

echo >&2 "Backing up mail"
mbsync --all

if [[ $(hostname 2>/dev/null) =~ ^(aang|suyin-arch)$ ]]; then
	echo >&2 "Backing up shaggydog work"
	for dir in "jasmin-dilithium" "jasmin" "libjade"; do
		rsync -ravuzzh --delete "$shaggydog:/home/dsprenkels/${dir}" "/home/daan/Documents/PhD/backup_replica/"
	done
	
	echo >&2 "Backing up lavendel work"
	rsync -ravuzzh --delete "$lavendel:/home/amber/timevault" "/home/daan/Documents/Code/backup_replica/"
fi

echo >&2 "Performing backups"
if [[ $(hostname 2>/dev/null) = aang ]]; then
	for dir in "Documents" ".config"; do
		echo >&2 "Backing up $dir to suki"
		rsync -ravuzzh --delete "$(realpath "/home/daan/${dir}")/" "$suki:/volume1/backup_replica/${hostname}/${dir}/"
	done
fi
for dir in "Documents" "Pictures" "Videos" "Games" ".factorio" ".config"; do
	echo >&2 "Backing up $dir to helikon"
	rsync -ravuzh --port 10622 --delete "$(realpath "/home/daan/${dir}")/" "$helikon:/volume1/homes/amber/katarastorage/private/backup/${hostname}_backup/${dir}/"
done

exit 0
